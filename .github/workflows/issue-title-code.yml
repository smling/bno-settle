name: Issue Title Code

on:
  issues:
    types:
      - opened

permissions:
  issues: write

jobs:
  add-code-prefix:
    name: Add Code Prefix To Issue Title
    runs-on: ubuntu-latest
    steps:
      - name: Prefix issue title with code
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labelNames = (issue.labels || [])
              .map((l) => (typeof l === "string" ? l : l.name || ""))
              .map((name) => name.toLowerCase());

            let code = "ISSUE";
            if (labelNames.includes("bug")) {
              code = "BUG";
            } else if (labelNames.includes("enhancement")) {
              code = "FEAT";
            }

            const serial = String(issue.number).padStart(4, "0");
            const prefix = `[${code}-${serial}]`;

            if (issue.title.startsWith(prefix)) {
              core.info("Issue title already has expected prefix. Skipping.");
              return;
            }

            const nextTitle = `${prefix} ${issue.title}`;
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              title: nextTitle
            });
